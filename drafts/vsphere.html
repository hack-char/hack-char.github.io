<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>VMware vSphere How To</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Char">

    <!-- Le styles -->
    <link rel="stylesheet" href="https://hack-char.github.io/theme/css/bootstrap.dark.css" type="text/css" />
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      .sidebar-nav {
        padding: 9px 0;
      }
      .tag-1 {
        font-size: 13pt;
      }
      .tag-2 {
        font-size: 10pt;
      }
      .tag-2 {
        font-size: 8pt;
      }
      .tag-4 {
        font-size: 6pt;
     }
    </style>
    <link href="https://hack-char.github.io/theme/css/bootstrap-responsive.dark.css" rel="stylesheet">
        <link href="https://hack-char.github.io/theme/css/font-awesome.css" rel="stylesheet">

    <link href="https://hack-char.github.io/theme/css/pygments.css" rel="stylesheet">

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="https://hack-char.github.io/theme/images/favicon.ico">
    <link rel="apple-touch-icon" href="https://hack-char.github.io/theme/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="https://hack-char.github.io/theme/images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="https://hack-char.github.io/theme/images/apple-touch-icon-114x114.png">

    <link href="https://hack-char.github.io/" type="application/atom+xml" rel="alternate" title="Hack Char ATOM Feed" />

  </head>

  <body>

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="https://hack-char.github.io/index.html">Hack Char </a>
          <div class="nav-collapse">
            <ul class="nav">
                          <li class="divider-vertical"></li>

                          <ul class="nav pull-right">
                                <li><a href="https://hack-char.github.io/archives.html"><i class="icon-th-list"></i>Archives</a></li>
                          </ul>

            </ul>
            <!--<p class="navbar-text pull-right">Logged in as <a href="#">username</a></p>-->
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row">
        <div class="span9" id="content">
<section id="content">
        <article>
                <header>
                        <h1>
                                <a href=""
                                        rel="bookmark"
                                        title="Permalink to VMware vSphere How To">
                                        VMware vSphere How To
                                </a>
                        </h1>
                </header>
                <div class="entry-content">
                <div class="well">
<footer class="post-info">
<span class="label">Date</span>
<abbr class="published" title="2018-03-17T00:00:00-07:00">
        <i class="icon-calendar"></i>Sat 17 March 2018
</abbr>
<span class="label">By</span>
<a href="https://hack-char.github.io/author/char.html"><i class="icon-user"></i>Char</a>
<span class="label">Category</span>
<a href="https://hack-char.github.io/category/cloud.html"><i class="icon-folder-open"></i>cloud</a>.


<span class="label">Tags</span>
	<a href="https://hack-char.github.io/tag/vm.html"><i class="icon-tag"></i>vm</a>
	<a href="https://hack-char.github.io/tag/vmware.html"><i class="icon-tag"></i>vmware</a>
</footer><!-- /.post-info -->                </div>
                <div class="section" id="rough-draft">
<h2>ROUGH DRAFT</h2>
<div class="section" id="vsphere-esxi">
<h3>vSphere / ESXi</h3>
<p>Most people that are familiar with cloud and virtualization have heard of VMware. However, many are not
familiar with the VMware bare-metal hypervisor ESXi nor it's vSphere/vCenter management interfaces. This
blog entry will help describe how to start using and learning about it.</p>
<p>This might use the terms ESXi and vSphere interchangably (like the VMware webpage), however, they are
differnt things. The term vSphere refers to the various management interfaces of the ESXi bare-metal
hypervisor.</p>
<div class="section" id="background">
<h4>Background</h4>
<p>This is written based on some experience attempting to learn about vSphere and ESXi. An important thing
to note at the beginning is that the latest version of ESXi will <em>NOT</em> run on <em>MOST</em> hardware. It's strictly
limited to drivers that support the latest and greatest hardware available. That limits what VMware has to
support and potentially makes ESXi <cite>better</cite> from the standpoint of not requiring too much old hardware backward
compatibility. It does make it a real pain to play with for a home user. However, it runs perfectly fine in a
Qemu virtual machine. And Qemu runs on Linux which can be installed on just about any hardware you have.</p>
<p>:) Linux :)</p>
<p>Also, you can get started right away with the free version of ESXi and even use the 60-day trial vSphere
and vCenter products. If you are lucky enough to have hardware that will run ESXi directly, you likely don't
want to keep re-installing it every 60 days. Assuming you're using it for personal use, you can get a complete
set of VMware licenses for ~$200/yr by joining VMUG VMware User's Group.</p>
<p>This blog How To is using examples running on a machine with an Intel Core i7 and 32GB RAM. If you have less
than 12GB RAM, you won't be running the vCenter virtual machine as that VM takes 10GB. You can try using a very
large swap partition, but expect it to be <em>PAINFULLY SLOW</em>.</p>
</div>
<div class="section" id="lab">
<h4>Lab</h4>
<p>ESXi is the hypervisor and you might think the first step is to install it. You would be <strong>wrong</strong>.
The VMware ecosystem expects an enterprise environment where there is 'DNS', 'DHCP' and 'NTP' servers running. It
integrates really well in a Windows Server environment, but this makes it a bit of a pain for a home user to
start using it.</p>
<p>I found the easiest approach was to spin up a base Debian server with BIND, DHCP and NTP running on it and then
serving these to my local VMs. Using QS (Qemu) it is currently taking up 1% CPU and 360MB RAM on my laptop. Your
first mission will be to supply these services to your lab environment.</p>
<p>Decide on how many instances of ESXi you would like to run as well as vCenter. Each will take an IP address and
should be resolvable. This blog will install the vCenter Server Appliance (a VM) on top of an ESXi hypervisor.
The vCenter VM will take 10GB RAM and the ESXi being made will be allocated 12GB. Further down we will make
four ESXi instances, two with 12GB and two with 4GB RAM. This in the end required also using swap space on my
machine that has 32GB memory.</p>
<p>I've found that using ZFS with LZ4 compression to make my virtual machine life <cite>significantly</cite> better. If you
don't have some method of using a compressed filesystem, expect you will be using a tremendous amount of space.
In the end I allocated 500GB for ESXi1 and 100GB for 2 through 4 for a total of 800GB. This will work for the
examples below, but will severely limit how many VMs you can load. Using ZFS with LZ4 compression, the amount
of underlying disk space I used is 28GB total. Using compressed disk space is likely one reason it took ~1 hour
to let vCenter install.</p>
</div>
<div class="section" id="installing-esxi">
<h4>Installing ESXi</h4>
<ol class="arabic simple">
<li>Make the underlying storage for the first ESXi instance ESXi1. <code>qemu-img create -f raw esxi1.raw 500GB</code></li>
<li>Create the QS definition for esxi1 <code>${HOME}/.qs/esxi1.conf</code></li>
</ol>
<blockquote>
<div class="highlight"><pre><span></span>vm esxi1
     cores <span class="m">2</span>
     mem <span class="m">12</span>
     internet <span class="m">10</span>.1.1.155
     image /rpool1/vm/esxi1.raw
     raw
     cpu host
</pre></div>
</blockquote>
<p>You will need to specify the actual path to the storage file you created in '1'. If you made a qcow2 image,
do not include 'raw'. You will have to include 'cpu host' otherwise ESXi won't install. You could also include
'vnc &lt;password&gt;' if you want to run headless normally and just connect using VNC (for example using tightvnc).
Also 'mute true' would disable the ALSA audio for this VM which would be appropriate in this case.</p>
<ol class="arabic simple" start="3">
<li>Install the hypervisor using <code>qs up esxi1 bootonce /var/iso/VMware-VMvisor-Installer-6.5.0.update01-5969303.x86_64.iso</code>
You will need to interact with the VM and choose appropriate options as you go.</li>
</ol>
</div>
<div class="section" id="multiple-esxi">
<h4>Multiple ESXi</h4>
<p>Go ahead and make copies of the storage file you just created for esxi1. Alternately you can create smaller files in the
100GB range and install again. If you make copies, be prepared to:</p>
<p>1) Delete and re-create your storage in each VM. You can select VMFS6 instead of the default VMFS5. This is necessary if you
want to connect this ESXi to vCenter. Otherwise the storage on each ESXi will have the same UUID and will conflict as you
add it to vCenter.</p>
<p>2) Assign a unique IP address to each ESXi. I chose to use static IP addresses. If you want to use DHCP, you'll need to
apply a uniquely defined ethernet MAC to each QS vm description <code>ether 11:22:33:44:55:66</code> for example, and specify
the IP to be assigned by your DHCP server such that the name is resolved correctly. I chose to use esxi1.local, esxi2.local,
esxi3.local and esxi4.local.</p>
</div>
<div class="section" id="installing-vcenter">
<h4>Installing vCenter</h4>
<p>Remember: <em>BE PATIENT</em></p>
<p>If you interrupt the installation process of the VM, it will not work and you will need to delete it and start over.</p>
<p>1) I hate running executables from other companies when I shouldn't have to. So I refused to use the executable with the VCSA ISO.
I extracted VMware-vCenter-Server-Appliance-6.5.0.10000-5973321_OVF10.ova from the installation ISO and then imported that into
esxi1.</p>
<p>2) <em>BE PATIENT</em>. You'll see a number of different changes in the console as VCSA is being booted and running its never-ending
installation scripts. <em>DO NOT MESS WITH IT</em>. <em>IF YOU MESS WITH IT YOU WILL BE DELETING IT AND STARTING OVER</em>.</p>
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-10_19-32-51.png" style="width: 800px;" />
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-10_19-33-56.png" style="width: 800px;" />
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-10_19-35-45.png" style="width: 800px;" />
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-10_19-41-23.png" style="width: 800px;" />
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-10_19-42-40.png" style="width: 800px;" />
<hr class="docutils" />
<p>3) When you see this screen showing it was assigned a DHCP address (even if you manually chose an IP address to assign it), you
are ready to log into it. You'll need to log in on the console the first time to set the root password. It will not require a default
at this point but step you through a 2-step verification of a new root password.
If you want to be sporty and see what the heck it is doing before this screen, you can log in using the pre-default 'vmware' password
for root. But be warned, you will probably mess something up and have to re-install <em>again</em>. I installed this thing a million times.</p>
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-10_19-47-52.png" style="width: 800px;" />
<hr class="docutils" />
<p>4) When you are at this point, you can finally open the web interface of the VCSA VM. 'If you're using QS', be warned, you will need
to add the IP or IP range that this VCSA VM has to the NFTables trusted_ip set. If you don't then it will block this IP and you won't
be happy. You will be :( or at best :|</p>
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-10_19-54-17.png" style="width: 800px;" />
<hr class="docutils" />
<p>5) Yet more installation screens. Yes, you thought you were done installing VCSA, but YOU WERE NOT! Follow through the rest of these
installation screens to let it kick off yet more scripts. It is important to fill in and remember the Single Sign On (SSO) set up
as you will need to enter the <a class="reference external" href="mailto:'administrator&#64;some.sso">'administrator&#64;some.sso</a>' as your username at the final, real web interface.</p>
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-10_19-54-38.png" style="width: 800px;" />
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-10_19-55-07.png" style="width: 800px;" />
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-10_19-56-48.png" style="width: 800px;" />
<hr class="docutils" />
<p>6) I found that this entire process of installing VCSA took be about one hour. Most of which is just spent waiting for the
darn scripts to run. When it's finally done, you can log in and see all the glory that is vCenter.</p>
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-10_20-00-28.png" style="width: 800px;" />
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-10_20-02-46.png" style="width: 800px;" />
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-10_20-07-42.png" style="width: 800px;" />
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-10_20-14-06.png" style="width: 800px;" />
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-10_20-18-49.png" style="width: 800px;" />
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-10_20-20-34.png" style="width: 800px;" />
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-10_20-21-03.png" style="width: 800px;" />
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-10_20-21-31.png" style="width: 800px;" />
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-10_20-26-15.png" style="width: 800px;" />
<hr class="docutils" />
<div class="section" id="attaching-esxi-hosts-to-vcenter">
<h5>Attaching ESXi Hosts to vCenter</h5>
<p>It might seem strange, but you can attach the hosting ESXi instance to vCenter running inside it. It works just fine. Furthermore,
after I attached all four ESXi instances, I then performed a magic migration while vCenter was running from esxi1 to esxi4.
It took a really long time, however, the VM kept running throughout the process! Thats the primary benefit I've seen to using vCenter
and managing a larger pool of ESXi hosts. In addition, you won't need to manually log in to however many ESXi you have, just to the single
vCenter instance when managing your VMware cloud.</p>
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-10_20-30-03.png" style="width: 800px;" />
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-10_20-31-16.png" style="width: 800px;" />
</div>
<hr class="docutils" />
<div class="section" id="migrating-a-vm-using-vmotion">
<h5>Migrating a VM using vMotion</h5>
<p>To migrate a VM, you'll use 'vMotion'. You must enable 'vMotion' on the sending and receiving ESXi hosts. Then it's simply a matter of
right-clicking and choosing to migrate. You can choose to migrate the storage or just the execution. In this example both storage and
execution were migrated. You can see how at the very end the actual execution was migrated such that the running VM was not disrupted.</p>
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-11_14-56-57.png" style="width: 800px;" />
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-11_14-58-44.png" style="width: 800px;" />
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-11_15-06-34.png" style="width: 800px;" />
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-11_15-10-18.png" style="width: 800px;" />
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-11_15-15-21.png" style="width: 800px;" />
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-11_15-17-47.png" style="width: 800px;" />
<hr class="docutils" />
<img alt="" src="/cloud/vmware/Screenshot_2018-03-11_15-19-13.png" style="width: 800px;" />
</div>
<hr class="docutils" />
<div class="section" id="making-a-new-vm">
<h5>Making a new VM</h5>
<p>There's a nice interface on ESXi to help you create new VMs. I however, like Qemu and my QS tool and want to use VMs I made there inside
of ESXi. It's not that tough...</p>
<ol class="arabic simple">
<li>Make a 'dummy' VM in ESXi. Follow the prompts and make a VM that corresponds with the Linux flavor you actually want. Make sure to
choose 'lsilogic' as the storage adapter.</li>
<li>Export that VM and you'll get a VMDK and OVF file on your local machine.</li>
<li>Convert your Qemu storage image from either qcow2 or raw to VMDK. <em>THIS IS IMPORTANT</em>. You must include the following option on the
'qemu-img' convert utility to make the VMDK a 'streamOptimized' flavor of VMDK. ESXi just doesn't like the default that qemu-img spits out.
<code>qemu-img convert -O vmdk /rpool1/vm/deb.raw -o adapter_type=lsilogic,subformat=streamOptimized,compat6 deb.vmdk</code>
The important bit is <code>-o adapter_type=lsilogic,subformat=streamOptimized,compat6</code>.</li>
<li>Update your OVF file to point to this VMDK you just made and make any other modifications you might want.</li>
<li>Use tar to make your OVA and include the OVF before your VMDK.</li>
<li>That's it! You now have a VMware friendly OVA that you can import into ESXi (or Workstation, etc)</li>
</ol>
</div>
<div class="section" id="ansible">
<h5>Ansible</h5>
<p>For extra credit... I have not yet done this. There are modules for ansible that can communicate with your ESXi hosts allowing for
automated VM configuration and management.</p>
</div>
</div>
</div>
</div>

                </div><!-- /.entry-content -->
        </article>
</section>
        </div><!--/span-->

                <div class="span3 well sidebar-nav" id="sidebar">
<ul class="nav nav-list">
<li class="nav-header"><h4><i class="icon-external-link"></i>blogroll</h4></li>
    <li><a href="https://github.com/hack-char"><i class="icon-external-link"></i>Hack Char @ GitHub</a></li>
<li class="nav-header"><h4><i class="icon-home icon-large"></i> social</h4></li>
<li><a href="https://hack-char.github.io/" rel="alternate"><i class="icon-bookmark icon-large"></i>atom feed</a></li>
    <li><a href="https://twitter.com/@Hack_Char"><i class="icon-Hack Char @ Twitter-sign icon-large"></i>Hack Char @ Twitter</a></li>

<li class="nav-header"><h4><i class="icon-folder-close icon-large"></i>Categories</h4></li>

<li class="nav-header"><h4><i class="icon-tags icon-large"></i>Tags</h4></li>


</ul>        </div><!--/.well -->

      </div><!--/row-->

      <hr>

      <footer>
        <address id="about">
                Proudly powered by <a href="http://pelican.notmyidea.org/">Pelican <i class="icon-external-link"></i></a>,
                                which takes great advantage of <a href="http://python.org">Python <i class="icon-external-link"></i></a>.
        </address><!-- /#about -->

        <p>The theme is based on <a href="http://twitter.github.com/bootstrap/">Bootstrap from Twitter <i class="icon-external-link"></i></a>,
                   and <a href="http://fortawesome.github.com/Font-Awesome/">Font-Awesome <i class="icon-external-link"></i></a>, thanks!</p>
      </footer>

    </div><!--/.fluid-container-->



    <!-- Le javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://hack-char.github.io/theme/js/jquery-1.7.2.min.js"></script>
    <script src="https://hack-char.github.io/theme/js/bootstrap.min.js"></script>
  </body>
</html>